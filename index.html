<script>
        class GymTimer {
            constructor() {
                this.isWorkoutActive = false;
                this.isSetActive = false;
                this.isResting = false;
                this.isPaused = false;
                this.setStartTime = null;
                this.workoutStartTime = null;
                this.pauseStartTime = null; // Track when a pause starts
                this.pausedTime = 0; // Accumulate total paused time for a set
                this.totalWorkoutTime = 0;
                this.totalRestTime = 0;
                this.setsCount = 0;
                this.timer = null;
                this.restTimer = null;
                this.workoutData = this.loadData();
                this.currentWorkoutSets = [];
                
                this.updateDisplays();
                this.updateAnalytics();
                this.loadLogs();
            }

            loadData() {
                const stored = localStorage.getItem('gymTimerData');
                return stored ? JSON.parse(stored) : {
                    dailyStats: {},
                    weeklyStats: {},
                    monthlyStats: {},
                    allTimeStats: { longestWorkout: 0, mostSets: 0, totalWorkouts: 0 },
                    workoutLogs: []
                };
            }

            saveData() {
                localStorage.setItem('gymTimerData', JSON.stringify(this.workoutData));
            }

            formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            getDateKey(date = new Date()) {
                return date.toISOString().split('T')[0];
            }

            getWeekKey(date = new Date()) {
                const year = date.getFullYear();
                const weekNum = this.getWeekNumber(date);
                return `${year}-W${weekNum}`;
            }

            getMonthKey(date = new Date()) {
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            }

            getWeekNumber(date) {
                const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            }

            startWorkout() {
                this.isWorkoutActive = true;
                this.workoutStartTime = Date.now();
                this.totalWorkoutTime = 0;
                this.totalRestTime = 0;
                this.setsCount = 0;
                this.currentWorkoutSets = [];
                
                this.startSet();
                
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';
                document.getElementById('pauseBtn').style.display = 'inline-block';
                document.getElementById('endBtn').style.display = 'inline-block';
            }

            startSet() {
                this.isSetActive = true;
                this.isResting = false;
                this.isPaused = false;
                this.pausedTime = 0;
                this.setStartTime = Date.now();
                this.setsCount++;
                
                document.getElementById('timerType').textContent = `Set ${this.setsCount}`;
                document.getElementById('restNotification').style.display = 'none';
                
                this.startTimer();
            }

            startTimer() {
                if (this.timer) clearInterval(this.timer);
                
                this.timer = setInterval(() => {
                    if (!this.isPaused) {
                        const elapsed = Math.floor((Date.now() - this.setStartTime - this.pausedTime) / 1000);
                        document.getElementById('timerDisplay').textContent = this.formatTime(elapsed);
                    }
                }, 100);
            }

            stopTimer() {
                if (!this.isSetActive) return;

                // If it was paused when stopped, calculate final pause duration
                if (this.isPaused) {
                    this.pausedTime += Date.now() - this.pauseStartTime;
                    this.isPaused = false;
                    document.getElementById('pauseBtn').textContent = 'Pause';
                }
                
                const setDuration = Math.floor((Date.now() - this.setStartTime - this.pausedTime) / 1000);
                this.totalWorkoutTime += setDuration;
                
                this.currentWorkoutSets.push({
                    setNumber: this.setsCount,
                    duration: setDuration,
                    timestamp: Date.now()
                });
                
                this.isSetActive = false;
                this.pausedTime = 0;
                this.startRestTimer();
                
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                
                this.updateDisplays();
            }

            // --- ✨ NEW METHOD: Handles pausing and resuming ---
            pauseTimer() {
                if (!this.isSetActive || this.isResting) return;

                this.isPaused = !this.isPaused;
                const pauseBtn = document.getElementById('pauseBtn');

                if (this.isPaused) {
                    // We are now paused
                    this.pauseStartTime = Date.now();
                    pauseBtn.textContent = 'Resume';
                    // Stop the timer from updating the display text
                    if (this.timer) clearInterval(this.timer);
                } else {
                    // We are now resuming
                    this.pausedTime += Date.now() - this.pauseStartTime;
                    pauseBtn.textContent = 'Pause';
                    // Restart the timer to continue display updates
                    this.startTimer();
                }
            }

            startRestTimer() {
                this.isResting = true;
                const restStartTime = Date.now();
                
                document.getElementById('timerType').textContent = 'Rest Time';
                
                if(this.restTimer) clearInterval(this.restTimer);
                this.restTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - restStartTime) / 1000);
                    document.getElementById('timerDisplay').textContent = this.formatTime(elapsed);
                }, 100);

                setTimeout(() => {
                    if (this.isResting) {
                        document.getElementById('restNotification').style.display = 'block';
                        this.playNotificationSound();
                    }
                }, 60000);

                const stopBtn = document.getElementById('stopBtn');
                stopBtn.textContent = 'Start Next Set';
                stopBtn.onclick = () => {
                    const restDuration = Math.floor((Date.now() - restStartTime) / 1000);
                    this.totalRestTime += restDuration;
                    
                    if (this.restTimer) {
                        clearInterval(this.restTimer);
                        this.restTimer = null;
                    }
                    
                    stopBtn.textContent = 'Stop Set';
                    stopBtn.onclick = () => this.stopTimer();
                    
                    this.startSet();
                };
            }

            playNotificationSound() {
                const audioContext = new(window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'square';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            endWorkout() {
                if (this.timer) clearInterval(this.timer);
                if (this.restTimer) clearInterval(this.restTimer);

                const totalWorkoutDuration = this.isWorkoutActive ? Math.floor((Date.now() - this.workoutStartTime) / 1000) : 0;
                
                if (this.isWorkoutActive && this.setsCount > 0) {
                   this.saveWorkoutData(totalWorkoutDuration);
                }
                this.resetTimer();
            }

            saveWorkoutData(totalDuration) {
                const now = new Date();
                const dateKey = this.getDateKey(now);
                const weekKey = this.getWeekKey(now);
                const monthKey = this.getMonthKey(now);
                
                // Initialize stats if not exists
                if (!this.workoutData.dailyStats[dateKey]) this.workoutData.dailyStats[dateKey] = { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };
                if (!this.workoutData.weeklyStats[weekKey]) this.workoutData.weeklyStats[weekKey] = { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };
                if (!this.workoutData.monthlyStats[monthKey]) this.workoutData.monthlyStats[monthKey] = { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };

                // Update stats
                const stats = [this.workoutData.dailyStats[dateKey], this.workoutData.weeklyStats[weekKey], this.workoutData.monthlyStats[monthKey]];
                stats.forEach(stat => {
                    stat.totalTime += totalDuration;
                    stat.workoutTime += this.totalWorkoutTime;
                    stat.restTime += this.totalRestTime;
                    stat.sets += this.setsCount;
                });
                
                // Update all-time records
                this.workoutData.allTimeStats.totalWorkouts++;
                if (totalDuration > this.workoutData.allTimeStats.longestWorkout) this.workoutData.allTimeStats.longestWorkout = totalDuration;
                if (this.workoutData.dailyStats[dateKey].sets > this.workoutData.allTimeStats.mostSets) this.workoutData.allTimeStats.mostSets = this.workoutData.dailyStats[dateKey].sets;

                // Add workout log
                this.workoutData.workoutLogs.unshift({
                    date: now.toISOString(),
                    totalTime: totalDuration,
                    workoutTime: this.totalWorkoutTime,
                    restTime: this.totalRestTime,
                    sets: this.setsCount,
                    setsDetails: [...this.currentWorkoutSets]
                });
                
                this.workoutData.workoutLogs = this.workoutData.workoutLogs.slice(0, 50); // Keep last 50
                
                this.saveData();
                this.updateAnalytics();
                this.loadLogs();
            }

            resetTimer() {
                this.isWorkoutActive = false;
                this.isSetActive = false;
                this.isResting = false;
                this.isPaused = false;
                this.pausedTime = 0;
                this.totalWorkoutTime = 0;
                this.totalRestTime = 0;
                this.setsCount = 0;
                
                document.getElementById('timerType').textContent = 'Ready to Start';
                document.getElementById('timerDisplay').textContent = '00:00';
                document.getElementById('restNotification').style.display = 'none';
                
                document.getElementById('startBtn').style.display = 'inline-block';
                document.getElementById('stopBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('endBtn').style.display = 'none';
                document.getElementById('stopBtn').textContent = 'Stop Set';
                document.getElementById('pauseBtn').textContent = 'Pause';
                document.getElementById('stopBtn').onclick = () => this.stopTimer();
                
                this.updateDisplays();
            }

            updateDisplays() {
                const today = this.getDateKey();
                const todayStats = this.workoutData.dailyStats[today] || { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };
                
                let currentSets = todayStats.sets;
                let currentWorkoutTime = todayStats.workoutTime;
                let currentRestTime = todayStats.restTime;
                let totalGymTime = todayStats.totalTime;

                if (this.isWorkoutActive) {
                    currentSets += this.setsCount;
                    currentWorkoutTime += this.totalWorkoutTime;
                    currentRestTime += this.totalRestTime;
                    totalGymTime += Math.floor((Date.now() - this.workoutStartTime) / 1000);
                }

                document.getElementById('currentSets').textContent = currentSets;
                document.getElementById('currentWorkoutTime').textContent = this.formatTime(currentWorkoutTime);
                document.getElementById('currentRestTime').textContent = this.formatTime(currentRestTime);
                document.getElementById('totalGymTime').textContent = this.formatTime(totalGymTime);
            }

            updateAnalytics() {
                const today = this.getDateKey();
                const thisWeek = this.getWeekKey();
                const thisMonth = this.getMonthKey();
                
                const dailyStats = this.workoutData.dailyStats[today] || { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };
                const weeklyStats = this.workoutData.weeklyStats[thisWeek] || { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };
                const monthlyStats = this.workoutData.monthlyStats[thisMonth] || { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };
                
                // Daily
                document.getElementById('dailyTotal').textContent = this.formatTime(dailyStats.totalTime);
                document.getElementById('dailyWorkout').textContent = this.formatTime(dailyStats.workoutTime);
                document.getElementById('dailyRest').textContent = this.formatTime(dailyStats.restTime);
                document.getElementById('dailySets').textContent = dailyStats.sets;
                
                // Weekly
                document.getElementById('weeklyTotal').textContent = this.formatTime(weeklyStats.totalTime);
                document.getElementById('weeklyWorkout').textContent = this.formatTime(weeklyStats.workoutTime);
                document.getElementById('weeklyRest').textContent = this.formatTime(weeklyStats.restTime);
                document.getElementById('weeklySets').textContent = weeklyStats.sets;
                
                // Monthly
                document.getElementById('monthlyTotal').textContent = this.formatTime(monthlyStats.totalTime);
                document.getElementById('monthlyWorkout').textContent = this.formatTime(monthlyStats.workoutTime);
                document.getElementById('monthlyRest').textContent = this.formatTime(monthlyStats.restTime);
                document.getElementById('monthlySets').textContent = monthlyStats.sets;
                
                // All-time
                document.getElementById('longestWorkout').textContent = this.formatTime(this.workoutData.allTimeStats.longestWorkout);
                document.getElementById('mostSets').textContent = this.workoutData.allTimeStats.mostSets;
                document.getElementById('totalWorkouts').textContent = this.workoutData.allTimeStats.totalWorkouts;
            }

            loadLogs() {
                const logsContainer = document.getElementById('workoutLogs');
                
                if (this.workoutData.workoutLogs.length === 0) {
                    logsContainer.innerHTML = '<p style="opacity: 0.6; text-align: center;">No workouts logged yet.</p>';
                    return;
                }
                
                logsContainer.innerHTML = this.workoutData.workoutLogs.slice(0, 20).map((log, index) => {
                    const date = new Date(log.date);
                    const dateStr = date.toLocaleDateString();
                    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="log-entry">
                            <div class="log-header">
                                <div>
                                    <div>Workout - ${dateStr}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.7; font-weight: normal;">${timeStr}</div>
                                </div>
                                <button class="delete-btn" onclick="deleteWorkout(${index})">Delete</button>
                            </div>
                            <div class="log-details">
                                <strong>Total Time:</strong> ${this.formatTime(log.totalTime)} | 
                                <strong>Workout:</strong> ${this.formatTime(log.workoutTime)} | 
                                <strong>Rest:</strong> ${this.formatTime(log.restTime)} | 
                                <strong>Sets:</strong> ${log.sets}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // --- ✨ NEW METHOD: Deletes a workout log ---
            deleteWorkout(index) {
                if (confirm('Are you sure you want to delete this workout log? This cannot be undone.')) {
                    this.workoutData.workoutLogs.splice(index, 1);
                    this.recalculateAllStats();
                    this.saveData();
                    this.updateAnalytics();
                    this.loadLogs();
                }
            }

            // --- ✨ NEW METHOD: Rebuilds stats after a deletion ---
            recalculateAllStats() {
                // Reset all stats
                const newWorkoutData = {
                    dailyStats: {}, weeklyStats: {}, monthlyStats: {},
                    allTimeStats: { longestWorkout: 0, mostSets: 0, totalWorkouts: 0 },
                    workoutLogs: this.workoutData.workoutLogs // Keep the logs
                };
                
                // Recalculate from remaining logs (in reverse, from oldest to newest)
                for (const log of [...this.workoutData.workoutLogs].reverse()) {
                    const date = new Date(log.date);
                    const dateKey = this.getDateKey(date);
                    const weekKey = this.getWeekKey(date);
                    const monthKey = this.getMonthKey(date);

                    // Initialize stats objects if they don't exist
                    if (!newWorkoutData.dailyStats[dateKey]) newWorkoutData.dailyStats[dateKey] = { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };
                    if (!newWorkoutData.weeklyStats[weekKey]) newWorkoutData.weeklyStats[weekKey] = { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };
                    if (!newWorkoutData.monthlyStats[monthKey]) newWorkoutData.monthlyStats[monthKey] = { totalTime: 0, workoutTime: 0, restTime: 0, sets: 0 };

                    // Add log data to each stat period
                    const periods = [newWorkoutData.dailyStats[dateKey], newWorkoutData.weeklyStats[weekKey], newWorkoutData.monthlyStats[monthKey]];
                    periods.forEach(p => {
                        p.totalTime += log.totalTime;
                        p.workoutTime += log.workoutTime;
                        p.restTime += log.restTime;
                        p.sets += log.sets;
                    });
                }
                
                // Recalculate All-Time stats
                newWorkoutData.allTimeStats.totalWorkouts = newWorkoutData.workoutLogs.length;
                let longestWorkout = 0;
                let mostSets = 0;
                newWorkoutData.workoutLogs.forEach(log => {
                    if (log.totalTime > longestWorkout) longestWorkout = log.totalTime;
                    if (log.sets > mostSets) mostSets = log.sets;
                });
                newWorkoutData.allTimeStats.longestWorkout = longestWorkout;
                newWorkoutData.allTimeStats.mostSets = mostSets;

                this.workoutData = newWorkoutData;
            }

            clearLogs() {
                if (confirm('Are you sure you want to clear all workout data? This cannot be undone.')) {
                    this.workoutData = {
                        dailyStats: {}, weeklyStats: {}, monthlyStats: {},
                        allTimeStats: { longestWorkout: 0, mostSets: 0, totalWorkouts: 0 },
                        workoutLogs: []
                    };
                    this.saveData();
                    this.updateAnalytics();
                    this.loadLogs();
                }
            }
        }

        // --- GLOBAL SCOPE ---
        // Only one set of clean global functions
        let gymTimer;

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (gymTimer) {
                if (tabName === 'analytics') {
                    gymTimer.updateAnalytics();
                } else if (tabName === 'logs') {
                    gymTimer.loadLogs();
                }
            }
        }

        function startWorkout() {
            if (gymTimer) gymTimer.startWorkout();
        }

        function stopTimer() {
            if (gymTimer) gymTimer.stopTimer();
        }

        function pauseTimer() {
            if (gymTimer) gymTimer.pauseTimer();
        }

        function endWorkout() {
            if (confirm('Are you sure you want to end this workout?')) {
                if (gymTimer) gymTimer.endWorkout();
            }
        }

        function deleteWorkout(index) {
            if (gymTimer) gymTimer.deleteWorkout(index);
        }

        function clearLogs() {
            if (gymTimer) gymTimer.clearLogs();
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            gymTimer = new GymTimer();
            
            // This interval can be intensive. Only update when the workout is active.
            setInterval(() => {
                if (gymTimer && gymTimer.isWorkoutActive) {
                    gymTimer.updateDisplays();
                }
            }, 1000);
        });

        window.addEventListener('beforeunload', function(e) {
            if (gymTimer && gymTimer.isWorkoutActive) {
                e.preventDefault();
                e.returnValue = 'You have an active workout. Are you sure you want to leave?';
                return e.returnValue;
            }
        });
    </script>
